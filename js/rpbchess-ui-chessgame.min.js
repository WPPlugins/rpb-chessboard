(function(e,t,n){"use strict";function Mt(e){return e===o||e==="?"?o:e}function _t(e){if(e===o||e==="????.??.??")return o;if(e.match(/([0-9]{4})\.([0-9]{2})\.([0-9]{2})/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3);return t.isValid()?jt(t.format("LL")):e}if(e.match(/([0-9]{4})\.([0-9]{2})\.\?\?/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-01");return t.isValid()?jt(t.format("MMMM YYYY")):e}return e.match(/([0-9]{4})\.\?\?\.\?\?/)?RegExp.$1:e}function Dt(e){switch(e){case"*":return o;case"1/2-1/2":return"&#189;&#8211;&#189;";case"1-0":return"1&#8211;0";case"0-1":return"0&#8211;1";default:return e}}function Pt(e){return e===o||e==="-"?o:e}function Bt(e){return e===o?o:e in Ht?Ht[e]:"$"+e}function jt(e){return e[C]===0?"":e.charAt(0).toUpperCase()+e.slice(1)}function Ft(e,t,n,r){var i=t-n,s="...";i<=0&&(i=0,s="");var o=t+1+r,u="...";o>=e[C]&&(o=e[C],u="");var a=s+e.substr(i,o-i)+u;return a=a[Q](/\n|\t/g," "),a+"\n"+(new Array(1+s[C]+t-i)).join(" ")+"^"}function It(e){var n=t.Color(e);return n.lightness()>.5?"black":"white"}function qt(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e===tt?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?T:e==="false"||e==="0"||e==="off"?g:t):t}function Rt(e){switch(e){case N:case pt:case at:case _:case A:case"above":case"below":return e;default:return et}}function Ut(e){switch(e){case"merida":case"pirat":break;default:e="alpha"}var t='<span class="rpbui-chessgame-'+e+'Font">',n=d,r={K:t+"K"+n,Q:t+"Q"+n,R:t+"R"+n,B:t+"B"+n,N:t+"N"+n,P:t+"P"+n};return{font:e,pieceSymbolTable:r}}function zt(e){var t={};return typeof e[z]!==p&&(t[z]=e[z]),typeof e[nt]!==p&&(t[nt]=e[nt]),typeof e[W]!==p&&(t[W]=e[W]),typeof e[yt]!==p&&(t[yt]=e[yt]),typeof e[gt]!==p&&(t[gt]=e[gt]),typeof e[X]!==p&&(t[X]=e[X]),typeof e[V]!==p&&(t[V]=e[V]),t}function Wt(e,n){return typeof n!==tt||n===""?"":(e[r].pgn="",e[v]=o,t.get(n).done(function(t){e[r].pgn=Xt(e,t),Jt(e)}).fail(function(){e[v]={title:t[c][J].PGN_DOWNLOAD_ERROR_MESSAGE,message:n},Jt(e)}),n)}function Xt(t,n){typeof n!==tt&&(n="*"),n=n[Q](/^\s+|\s+$/g,"");try{t[v]=e.pgn.parseOne(n,t[r].gameIndex)}catch(i){if(!(i instanceof e.exceptions.InvalidPGN))throw t[v]=o,i;t[v]=i}return n}function Vt(e,n){var r=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(n)){n=n.toUpperCase(),e[h]={};for(var i=0;i<6;++i)e[h][r[i]]=n.substr(i+1,1)}else if(/^:\w+$/.test(n)){var s=Ut(n.substr(1));n=":"+s.font,e[h]=s[ut]}else switch(n){case"figurines":e[h]=Ut(t[c].chessFont)[ut];break;case"localized":e[h]={};for(var i=0;i<6;++i){var o=r[i];e[h][o]=o in t[c][J][wt]?t[c][J][wt][o]:o}break;default:e[h]={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},n="native"}return n}function $t(e){var n=t(m,e[f]);n[C]!==0&&t(u)[it]("close"),e[f].empty()}function Jt(n){$t(n);if(n[v]===o)return;if(!(n[v]instanceof e.pgn.Item)){t(Zt(n))[vt](n[f]);return}var s="";s+=en(n,"White"),s+=en(n,"Black"),s+=tn(n),s+=nn(n),s+=rn(n),s!==""&&(s='<div class="rpbui-chessgame-headers">'+s+l);var u=ln(n),a=sn(n),c="",h="";switch(n[r][i]){case pt:case at:h=q+n[r][i][Q]("float","clear")+'"></div>',c='<div class="rpbui-chessgame-navigationBox rpbui-chessgame-'+n[r][i]+Nt+cn()+l;break;case _:c='<div class="rpbui-chessgame-scrollBox"><div class="rpbui-chessgame-navigationBox rpbui-chessgame-scrollLeft">'+cn()+'</div><div class="rpbui-chessgame-scrollArea">',h=ct;break;case A:c='<div class="rpbui-chessgame-scrollBox"><div class="rpbui-chessgame-scrollArea">',h='</div><div class="rpbui-chessgame-navigationBox rpbui-chessgame-scrollRight">'+cn()+ct;break;case"above":c='<div class="rpbui-chessgame-navigationBox rpbui-chessgame-above">'+cn()+l;break;case"below":h='<div class="rpbui-chessgame-navigationBox rpbui-chessgame-below">'+cn()+l}t(c+u+s+a+h)[vt](n[f]),Kt(n),n[r][i]!==et&&(Qt(n),Gt(n),n[r][i]!==N&&Yt(n),(n[r][i]===_||n[r][i]===A)&&t(R,n[f]).css($,t(".rpbui-chessgame-navigationBox",n[f])[$]()))}function Kt(e){t(".rpbui-chessgame-comment .rpbui-chessgame-diagramAnchor",e[f]).each(function(n,i){var s=t(i),o=s.closest(".rpbui-chessgame-comment"),u=o[ot](w),a=o[ot]("csl"),f=o[ot]("cal"),l={position:u};typeof a!==p&&(l[Et]=a),typeof f!==p&&(l[Tt]=f),t.extend(l,e[r][H]);try{t.extend(l,zt(t.parseJSON(s.text())))}catch(c){}s.empty()[lt]("rpbui-chessgame-diagramAnchor")[Ct]("rpbui-chessgame-diagram")[y](l)})}function Qt(e){t(k,e[f])[mt](function(){dn(e,t(this),T)})}function Gt(e){t(".rpbui-chessgame-variation",e[f]).each(function(e,n){var r=t(n),i=r.is("div")?r[kt](".rpbui-chessgame-moveGroup")[kt](k):r[kt](k),s=o;i.each(function(e,n){var r=t(n);s!==o&&(r[ot](F,s),s[ot](B,r)),s=r})});var n=t(I,e[f]),r=t(".rpbui-chessgame-variation .rpbui-chessgame-move",e[f]);if(r[C]!==0){var i=r.first();i[ot](F,n),n[ot](B,i)}}function Yt(e){t(j,e[f])[y](e[r][a]),hn(function(n){return t(n,e[f])},function(t){e[t]()}),dn(e,t(I,e[f]),g)}function Zt(n){var r=n[v]instanceof e.exceptions.InvalidPGN?t[c][J].PGN_PARSING_ERROR_MESSAGE:n[v].title,i='<div class="rpbui-chessgame-error"><div class="rpbui-chessgame-errorTitle">'+r+l;return n[v].message!==o&&(i+='<div class="rpbui-chessgame-errorMessage">'+n[v].message+l),n[v].index!==o&&n[v].index>=0&&(i+='<div class="rpbui-chessgame-errorAt">',n[v].index>=n[v].pgn[C]?i+="Occurred at the end of the string.":i+="Occurred at position "+n[v].index+":"+'<div class="rpbui-chessgame-errorAtCode">'+Ft(n[v].pgn,n[v].index,10,40)+l,i+=l),i+=l,i}function en(e,t){var n=Mt(e[v][Y](t));if(n===o)return"";var r=q+t.toLowerCase()+'Player">'+'<span class="rpbui-chessgame-colorTag"></span> '+'<span class="rpbui-chessgame-playerName">'+n+d,i=Pt(e[v][Y](t+"Title")),s=Mt(e[v][Y](t+"Elo"));if(i!==o||s!==o)r+='<span class="rpbui-chessgame-titleRatingGroup">',i!==o&&(r+='<span class="rpbui-chessgame-playerTitle">'+i+d),s!==o&&(r+='<span class="rpbui-chessgame-playerRating">'+s+d),r+=d;return r+=l,r}function tn(e){var t=Mt(e[v][Y]("Event"));if(t===o)return"";var n=Mt(e[v][Y]("Round")),r='<div class="rpbui-chessgame-event">'+t;return n!==o&&(r+='<span class="rpbui-chessgame-round">'+n+d),r+=l,r}function nn(e){var t=_t(e[v][Y]("Date")),n=Mt(e[v][Y]("Site"));if(t===o&&n===o)return"";var r='<div class="rpbui-chessgame-datePlaceGroup">';return t!==o&&(r+='<span class="rpbui-chessgame-date">'+t+d),n!==o&&(r+='<span class="rpbui-chessgame-site">'+n+d),r+=l,r}function rn(e){var n=Mt(e[v][Y]("Annotator"));if(n===o)return"";var r='<div class="rpbui-chessgame-annotator">'+t[c][J].ANNOTATED_BY[Q](/%1\$s/g,'<span class="rpbui-chessgame-annotatorName">'+n+d)+l;return r}function sn(e){var t=on(e,e[v][At](),T,Dt(e[v].result()));if(t.content==="")return"";var n="rpbui-chessgame-body";return t.divCount>1&&(n+=" rpbui-chessgame-moreSpace"),e[r][i]!==et&&(n+=" rpbui-chessgame-clickableMoves"),'<div class="'+n+Nt+t.content+l}function on(e,t,n,r){function c(){u&&!a&&(s+='<div class="rpbui-chessgame-moveGroup">',a=T,++f)}function h(){a&&(s+=l,a=g)}if(t[ft]()===o&&t.first()===o&&r===o)return n?{content:"",divCount:0}:"";var i=t[K]()?"div":"span",s="<"+i+' class="rpbui-chessgame-variation'+(n?"":" rpbui-chessgame-subVariation")+Nt,u=t[K](),a=g,f=0;t[ft]()!==o&&(t[Z]()?++f:c(),s+=an(t));var p=T,v=t.first();while(v!==o){c(),s+=fn(e,v,p),v[ft]()!==o&&(v[Z]()&&(h(),++f),s+=an(v));var m=0,y=v.variations();for(var b=0;b<y[C];++b){var w=on(e,y[b],g,o);w!==""&&(y[b][K]()?(h(),++f):c(),s+=w,++m)}p=v[ft]()!==o||m>0,v=v.next()}return n&&r!==o&&(c(),s+='<span class="rpbui-chessgame-result">'+r+d),h(),s+="</"+i+">",n?{content:s,divCount:f}:s}function un(e,t){var n='data-position="'+e[w]().fen()+'"';t&&(n+=' data-position-before="'+e[dt]().fen()+'" data-move-notation="'+e.move()+'"');var r=e.tag("csl");r!==o&&(n+=' data-csl="'+r+'"');var i=e.tag("cal");return i!==o&&(n+=' data-cal="'+i+'"'),n}function an(e){var t=e[Z]()?"div":"span";return"<"+t+' class="rpbui-chessgame-comment" '+un(e,g)+">"+e[ft]()+"</"+t+">"}function fn(e,t,n){var r='<span class="rpbui-chessgame-move" '+un(t,T)+">",i=n||t.moveColor()==="w",s="rpbui-chessgame-moveNumber"+(i?"":" rpbui-chessgame-hidden"),o=t.fullMoveNumber()+(t.moveColor()==="w"?".":"…");r+='<span class="'+s+Nt+o+d;var u=e[h];r+=t.move()[Q](/[KQRBNP]/g,function(e){return u[e]});var a=t.nags();for(var f=0;f<a[C];++f)r+=" "+Bt(a[f]);return r+=d,r}function ln(e){return'<div class="rpbui-chessgame-move rpbui-chessgame-initialMove" '+un(e[v][At](),g)+">"+t[c][J].INITIAL_POSITION+l}function cn(){return'<div class="rpbui-chessgame-navigationBoard"></div><div class="rpbui-chessgame-navigationButtons '+t[c].navigationButtonClass+Nt+E+t[c][J].GO_FIRST_MOVE_TOOLTIP+'" class="rpbui-chessgame-navigationButtonFirst"></div>'+E+t[c][J].GO_PREVIOUS_MOVE_TOOLTIP+'" class="rpbui-chessgame-navigationButtonPrevious"></div>'+E+t[c][J].GO_NEXT_MOVE_TOOLTIP+'" class="rpbui-chessgame-navigationButtonNext"></div>'+E+t[c][J].GO_LAST_MOVE_TOOLTIP+'" class="rpbui-chessgame-navigationButtonLast rpbui-chessgame-spaceAfter"></div>'+E+t[c][J].FLIP_TOOLTIP+'" class="rpbui-chessgame-navigationButtonFlip rpbui-chessgame-spaceAfter"></div>'+E+t[c][J].DOWNLOAD_PGN_TOOLTIP+'" class="rpbui-chessgame-navigationButtonDownload rpbui-chessgame-spaceAfter"></div>'+l+'<a href="#" download="game.pgn" class="rpbui-chessgame-blobDownloadLink"></a>'}function hn(e,t){e(".rpbui-chessgame-navigationButtons").disableSelection(),e(".rpbui-chessgame-navigationButtonFirst")[ht]({icons:{primary:"ui-icon-seek-first"},text:g})[mt](function(){t("goFirstMove")}),e(".rpbui-chessgame-navigationButtonPrevious")[ht]({icons:{primary:"ui-icon-seek-prev"},text:g})[mt](function(){t("goPreviousMove")}),e(".rpbui-chessgame-navigationButtonNext")[ht]({icons:{primary:"ui-icon-seek-next"},text:g})[mt](function(){t("goNextMove")}),e(".rpbui-chessgame-navigationButtonLast")[ht]({icons:{primary:"ui-icon-seek-end"},text:g})[mt](function(){t("goLastMove")}),e(O)[ht]({icons:{primary:"ui-icon-refresh"},text:g})[mt](function(){t(z)}),e(L)[ht]({icons:{primary:"ui-icon-extlink"},text:g})[mt](function(){t("downloadPGN")})}function pn(){if(t(u)[C]!==0)return;t('<div id="rpbui-chessgame-navigationFrame">'+cn()+l)[vt](t("body")),t(u)[it]({create:function(e){t(e.target).parent().css(w,bt)},resizeStart:function(e){t(e.target).parent().css(w,bt)},resizeStop:function(e){t(e.target).parent().css(w,bt)},autoOpen:g,dialogClass:t[c].navigationFrameClass,width:"auto",close:function(){Sn()}});var e=t(b);e[y](zt(t[c].navigationFrameOptions)),e[y]("sizeControlledByContainer",t(u),"dialogresize"),hn(function(e){return t(P+e)},function(n){var r=t(m).closest(".rpbui-chessgame");r[c](n);if(/^go/.test(n)){var i=t(s,r),o=T;i[Lt](U)&&(i=r,o=g);var u=i.offset();u.top<t(window)[rt]()?t(St)[xt]({scrollTop:u.top},200):o&&u.top+i[$]()>t(window)[rt]()+window.innerHeight&&t(St)[xt]({scrollTop:u.top+i[$]()-window.innerHeight},200)}})}function dn(e,n,a){if(n===undefined||n===o||n[Lt](S))return;e[r][i]===N&&pn(),vn(e),mn(e),yn(e,n,a),En(e,n);if(e[r][i]===N){var l=t(u);l[it]("isOpen")||(l[it](M,w,{my:"center",at:"center",of:window}),l[it]("open")),t(".ui-dialog-title",l.closest(".ui-dialog")).empty().append(n.html())}if(e[r][i]===_||e[r][i]===A){var c=t(s,e[f]),h=t(R,e[f]),p=T;c[Lt](U)&&(c=t(".rpbui-chessgame-headers",e[f]),p=g);var d=c.offset().top-h.offset().top;d<0?h[xt]({scrollTop:h[rt]()+d},200):p&&d+c[$]()>h[$]()&&h[xt]({scrollTop:h[rt]()+d+c[$]()-h[$]()},200)}}function vn(e){var t=bn(e);e[r][a][z]!==t[y](M,z)&&t[y](M,z,e[r][a][z])}function mn(e){gn(e,O,e[r][D]),gn(e,L,e[r][x])}function gn(e,n,s){var o=e[r][i]===N?t(P+n):t(n,e[f]);s?o.show():o.hide()}function yn(e,t,n){var r=bn(e);n?(r[y](M,w,t[ot](dt)),r[y]("play",t[ot]("moveNotation"))):r[y](M,w,t[ot](w));var i=t[ot]("csl"),s=t[ot]("cal");r[y](M,Et,typeof i===p?"":i),r[y](M,Tt,typeof s===p?"":s)}function bn(e){return e[r][i]===N?t(b):t(j,e[f])}function wn(e){return e[r][i]===N?t("#rpbui-chessgame-navigationFrame .rpbui-chessgame-blobDownloadLink"):t(".rpbui-chessgame-blobDownloadLink",e[f])}function En(e,n){var u=e[r][i]===N;Sn(u?o:t(s,e[f])),n[Ct](S),u&&n.attr("id","rpbui-chessgame-navigationFrameTarget");var a=n.css("color");n.css("background-color",a),n.css("color",It(a))}function Sn(e){if(e===undefined||e===o)e=t(m);e.attr("style",o).attr("id",o)[lt](S)}var r="options",i="navigationBoard",s=".rpbui-chessgame-selectedMove",o=null,u="#rpbui-chessgame-navigationFrame",a="navigationBoardOptions",f="element",l="</div>",c="chessgame",h="_pieceSymbolTable",p="undefined",d="</span>",v="_game",m="#rpbui-chessgame-navigationFrameTarget",g=!1,y="chessboard",b="#rpbui-chessgame-navigationFrame .rpbui-chessgame-navigationBoard",w="position",E='<div title="',S="rpbui-chessgame-selectedMove",x="showDownloadButton",T=!0,N="frame",C="length",k=".rpbui-chessgame-move",L=".rpbui-chessgame-navigationButtonDownload",A="scrollRight",O=".rpbui-chessgame-navigationButtonFlip",M="option",_="scrollLeft",D="showFlipButton",P="#rpbui-chessgame-navigationFrame ",H="diagramOptions",B="nextMove",j=".rpbui-chessgame-navigationBoard",F="prevMove",I=".rpbui-chessgame-initialMove",q='<div class="rpbui-chessgame-',R=".rpbui-chessgame-scrollArea",U="rpbui-chessgame-initialMove",z="flip",W="showCoordinates",X="animationSpeed",V="showMoveArrow",$="height",J="i18n",K="isLongVariation",Q="replace",G="pieceSymbols",Y="header",Z="isLongComment",et="none",tt="string",nt="squareSize",rt="scrollTop",it="dialog",st="rpbui-chessgame",ot="data",ut="pieceSymbolTable",at="floatRight",ft="comment",lt="removeClass",ct="</div></div>",ht="button",pt="floatLeft",dt="positionBefore",vt="appendTo",mt="click",gt="pieceset",yt="colorset",bt="fixed",wt="PIECE_SYMBOLS",Et="squareMarkers",St="html, body",xt="animate",Tt="arrowMarkers",Nt='">',Ct="addClass",kt="children",Lt="hasClass",At="mainVariation";t[c]={navigationFrameOptions:{},navigationFrameClass:"",navigationButtonClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},GO_FIRST_MOVE_TOOLTIP:"Go to the beginning of the game",GO_PREVIOUS_MOVE_TOOLTIP:"Go to the previous move",GO_NEXT_MOVE_TOOLTIP:"Go to the next move",GO_LAST_MOVE_TOOLTIP:"Go to the end of the game",FLIP_TOOLTIP:"Flip the board",DOWNLOAD_PGN_TOOLTIP:"Download the game",PGN_DOWNLOAD_ERROR_MESSAGE:"Cannot download the PGN file.",PGN_PARSING_ERROR_MESSAGE:"Error while analysing a PGN string."}};var Ot=o,Ht={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",11:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};t.widget("rpbchess-ui.chessgame",{options:{pgn:"*",url:"",gameIndex:-1,navigationBoard:et,navigationBoardOptions:{},diagramOptions:{},pieceSymbols:"native",showFlipButton:T,showDownloadButton:T},_game:o,_pieceSymbolTable:o,_create:function(){this[f][Ct](st),this[r].url=Wt(this,this[r].url),this[r].url||(this[r].pgn=Xt(this,this[r].pgn)),this[r][G]=Vt(this,this[r][G]),this[r][i]=Rt(this[r][i]),this[r][a]=zt(this[r][a]),this[r][H]=zt(this[r][H]),this[r][D]=qt(this[r][D],T),this[r][x]=qt(this[r][x],T),Jt(this)},_destroy:function(){$t(this),this[f][lt](st)},_setOption:function(e,t){switch(e){case"url":t=Wt(this,t);break;case"pgn":if(this[r].url)return;t=Xt(this,t);break;case G:t=Vt(this,t);break;case i:t=Rt(t);break;case a:t=zt(t);break;case H:t=zt(t);break;case D:t=qt(t,T);break;case x:t=qt(t,T)}this[r][e]=t,Jt(this)},goFirstMove:function(){var e=t(s,this[f]);if(e[C]===0)return;while(e[ot](F)!==undefined)e=e[ot](F);dn(this,e,g)},goPreviousMove:function(){dn(this,t(s,this[f])[ot](F),g)},goNextMove:function(){dn(this,t(s,this[f])[ot](B),T)},goLastMove:function(){var e=t(s,this[f]);if(e[C]===0)return;while(e[ot](B)!==undefined)e=e[ot](B);dn(this,e,g)},flip:function(){this[r][a][z]=!this[r][a][z],vn(this)},downloadPGN:function(){if(this[r].url)window.location.href=this[r].url;else{var e=new Blob([this[r].pgn],{type:"text/plain"});Ot!==o&&window.URL.revokeObjectURL(Ot),Ot=window.URL.createObjectURL(e);var t=wn(this);t.attr("href",Ot),t.get(0)[mt]()}}})})(RPBChess,jQuery,moment);