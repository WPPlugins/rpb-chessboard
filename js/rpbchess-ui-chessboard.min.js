(function(e,t){"use strict";function Et(e,t){var n={},r=e.split(",");for(var i=0;i<r.length;++i)t[Q](r[i])&&(n[RegExp.$2]=RegExp.$1);return n}function St(e){var t=[];for(var n in e)e[A](n)&&t.push(e[n]+n);return t.join(",")}function xt(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?ot:e==="false"||e==="0"||e==="off"?O:t):t}function Tt(e){return Math.min(Math.max(e,dt),vt)}function Nt(e){if(typeof e=="string"){e=e.toLowerCase();if(/^[a-z0-9]+(?:-[a-z0-9]+)*$/[Q](e))return e}return""}function Ct(e){return e===st||e===at||/^addPieces-[wb][kqrbnp]$/[Q](e)||/^add(?:Square|Arrow)Markers-[GRY]$/[Q](e)?e:"none"}function kt(e){return Math.max(0,e)}function Lt(t,n){n=n.replace(/^\s+|\s+$/g,"");try{t[s]=new e.Position(n),n=t[s].fen()}catch(r){if(!(r instanceof e.exceptions.InvalidFEN))throw t[s]=E,r;t[s]=r}return n}function At(e,t){return e[i]=Et(t,gt),St(e[i])}function Ot(e,t){return e[r]=Et(t,yt),St(e[r])}function Mt(e){e[u][Y]()}function _t(e){var t='<div class="rpbui-chessboard-error"><div class="rpbui-chessboard-errorTitle">Error while analysing a FEN string.</div>';return e[s].message!==E&&(t+='<div class="rpbui-chessboard-errorMessage">'+e[s].message+C),t+=C,t}function Dt(t){var o=t[n][M]?P:H,u=t[n][M]?B:q,a="rpbui-chessboard-table rpbui-chessboard-size"+t[n][l];t[n][N]||(a+=" rpbui-chessboard-hideCoordinates"),t[n][$]!==""&&(a+=" rpbui-chessboard-colorset-"+t[n][$]),t[n][J]!==""&&(a+=" rpbui-chessboard-pieceset-"+t[n][J]);var f=W+a+'">';for(var c=0;c<8;++c){f+='<div class="rpbui-chessboard-row"><div class="rpbui-chessboard-cell rpbui-chessboard-rowCoordinate">'+o[c]+C;for(var h=0;h<8;++h){var d=u[h]+o[c],g=e.squareColor(d)==="w"?"light":"dark",y="rpbui-chessboard-sized rpbui-chessboard-cell rpbui-chessboard-square rpbui-chessboard-"+g+"Square";d in t[i]&&(y+=" rpbui-chessboard-squareMarker rpbui-chessboard-markerColor-"+t[i][d]),f+=W+y+'">';var b=t[s][m](d);b==="-"?f+=mt:f+=p+b.piece+X+b.color+'">'+mt+C,f+=C}f+='<div class="rpbui-chessboard-cell">';if(o[c]==="8"||o[c]==="1"){var w=o[c]==="8"?"b":"w",y="rpbui-chessboard-sized rpbui-chessboard-turnFlag rpbui-chessboard-color-"+w;w!==t[s].turn()&&(y+=" rpbui-chessboard-inactiveFlag"),f+=W+y+'"></div>'}f+="</div></div>"}f+='<div class="rpbui-chessboard-row rpbui-chessboard-columnCoordinateRow"><div class="rpbui-chessboard-cell rpbui-chessboard-rowCoordinate"></div>';for(var h=0;h<8;++h)f+='<div class="rpbui-chessboard-cell rpbui-chessboard-columnCoordinate">'+u[h]+C;f+='<div class="rpbui-chessboard-cell"></div></div>',f+='<svg class="rpbui-chessboard-annotations" viewBox="0 0 8 8"><defs><marker id="rpbui-chessboard-arrowMarkerEnd-G" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="rpbui-chessboard-arrowMarkerEnd-R" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="rpbui-chessboard-arrowMarkerEnd-Y" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="rpbui-chessboard-arrowMarkerEnd-B" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker></defs>';for(var S in t[r])if(t[r][A](S)&&/^([a-h][1-8])([a-h][1-8])$/[Q](S)){var T=RegExp.$1,L=RegExp.$2;if(T!==L){var O=Xt(t,T,L),y="rpbui-chessboard-arrowMarker rpbui-chessboard-arrowMarker-"+T+L+x+t[r][S],_=v+t[r][S]+")";f+='<line class="'+y+'" x1="'+O.x1+'" y1="'+O.y1+'" x2="'+O.x2+'" y2="'+O.y2+'" marker-end="'+_+'" />'}}if(t[k]!==E){var O=Xt(t,t[k].from,t[k].to);f+='<line class="rpbui-chessboard-arrowMarker rpbui-chessboard-moveArrow rpbui-chessboard-markerColor-B" x1="'+O.x1+'" y1="'+O.y1+'" x2="'+O.x2+'" y2="'+O.y2+'" marker-end="url(#rpbui-chessboard-arrowMarkerEnd-B)" />'}return f+="</svg>",f+=C,f}function Pt(r){Mt(r);if(r[s]===E)return;if(r[s]instanceof e.exceptions.InvalidFEN)t(_t(r)).appendTo(r[u]);else{t(Dt(r)).appendTo(r[u]);if(r[n][c]===st||r[n][c]===at)Vt(r),$t(r,r[n][c]===st);else if(/^addPieces-([wb])([kqrbnp])$/[Q](r[n][c])){var i=RegExp.$1,o=RegExp.$2;Vt(r),Jt(r,{color:i,piece:o})}else if(/^addSquareMarkers-([GRY])$/[Q](r[n][c])){var a=RegExp.$1;Vt(r),Kt(r,a)}else if(/^addArrowMarkers-([GRY])$/[Q](r[n][c])){var a=RegExp.$1;Vt(r),Qt(r,a)}}}function Ht(e){t(I,e[u])[tt](R)}function Bt(e,n,r){t(f,e[u])[b](G+n)[_](G+r)}function jt(e){t(f,e[u])[tt]("rpbui-chessboard-hideCoordinates")}function Ft(e,t,n){typeof t===y?e[_](h)[_](a+n):typeof n===y?e[b](h)[b](a+t):e[b](a+t)[_](a+n)}function It(e){var n=t(".rpbui-chessboard-squareMarker",e[u]);n[b]("rpbui-chessboard-markerColor-G"),n[b]("rpbui-chessboard-markerColor-R"),n[b]("rpbui-chessboard-markerColor-Y"),n[b](h);for(var r in e[i])if(e[i][A](r)){var s=e[i][r];zt(e,r)[_](h)[_](a+s)}}function qt(e,n,r,i){var s=F+n;if(typeof r===y){var o=n.substr(0,2),a=n.substr(2,2);if(o!==a){var f=Xt(e,o,a);Ut(e,s,i,f.x1,f.y1,f.x2,f.y2)}}else if(typeof i===y)t("."+s,e[u]).remove();else{var l=U+s+x+i,c=v+i+")";t("."+s,e[u]).attr("class",l).attr("marker-end",c)}}function Rt(e){t(".rpbui-chessboard-arrowMarker",e[u]).remove();for(var n in e[r])if(e[r][A](n)){var i=n.substr(0,2),s=n.substr(2,2);if(i!==s){var o=Xt(e,i,s),a=F+n;Ut(e,a,e[r][n],o.x1,o.y1,o.x2,o.y2)}}}function Ut(e,n,r,i,s,o,a){var f=U+n+x+r,l=v+r+")",c=t(document.createElementNS("http://www.w3.org/2000/svg","line"));return c.attr({x1:i,y1:s,x2:o,y2:a,"class":f,"marker-end":l}),t(j,e[u])[ft](c),c}function zt(e,r){var i=e[n][M]?P:H,s=e[n][M]?B:q,a=i[lt](r[1]),f=s[lt](r[0]);return t(t(o,e[u]).get(a*8+f))}function Wt(e,t){var r=e[n][M]?P:H,i=e[n][M]?B:q;return{x:i[lt](t[0])+.5,y:r[lt](t[1])+.5}}function Xt(e,t,n){var r=Wt(e,t),i=Wt(e,n);return i.x+=r.x<i.x?-0.3:r.x>i.x?.3:0,i.y+=r.y<i.y?-0.3:r.y>i.y?.3:0,{x1:r.x,y1:r.y,x2:i.x,y2:i.y}}function Vt(e){var r=e[n][M]?P:H,i=e[n][M]?B:q,s=0,a=0;t(o,e[u]).each(function(e,n){t(n).data(m,i[a]+r[s]),++a,a===8&&(a=0,++s)})}function $t(e,r){t(K,e[u])[ht]({cursor:"move",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},revert:ot,revertDuration:0,zIndex:300});var i=t(f,e[u]).get(0),s=r?Yt:Gt;t(o,e[u]).droppable({hoverClass:z,accept:function(e){return t(e).closest(f).get(0)===i},drop:function(r,i){var o=t(r.target),u=i[ht];if(u.hasClass("rpbui-chessboard-piece")){var a={from:u.parent().data(m),to:o.data(m)};s(e,a,O,e[n][T])}}})}function Jt(e,n){t(o,e[u]).mousedown(function(){nn(e,n,t(this).data(m),t(this))})}function Kt(e,n){t(o,e[u]).mousedown(function(){rn(e,n,t(this).data(m),t(this))})}function Qt(e,r){function p(e){return(e-s.left)*8/c}function d(e){return(e-s.top)*8/h}var i=E,s=E,a=t(j,e[u]),c=a.width(),h=a.height();t(".rpbui-chessboard-square .rpbui-chessboard-handle",e[u])[ht]({cursor:"crosshair",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},helper:function(){return t('<div class="rpbui-chessboard-sized"></div>')},start:function(n){i=t(n.target).closest(o).data(m),s=a.offset();var u=Wt(e,i);Ut(e,"rpbui-chessboard-draggedArrow",r,u.x,u.y,u.x,u.y)},drag:function(n){t(D,e[u]).attr({x2:p(n.pageX),y2:d(n.pageY)})},stop:function(){t(D,e[u]).remove()}});var v=t(f,e[u]).get(0);t(o,e[u]).droppable({hoverClass:z,accept:function(e){return t(e).closest(f).get(0)===v},drop:function(n){var s=t(n.target).data(m);sn(e,r,i,s)}})}function Gt(e,t,n,r){if(t.from===t.to||e[s][m](t.from)==="-")return;e[s][m](t.to,e[s][m](t.from)),e[s][m](t.from,"-"),Zt(e),en(e,t.from,t.to,n,r),on(e)}function Yt(n,r,i,o){var a=n[s].isMoveLegal(r);if(!a)return;n[s][st](a),Zt(n);var f=en(n,a.from(),a.to(),i,o);a.type()===e[pt].CASTLING_MOVE&&en(n,a.rookFrom(),a.rookTo(),i,O),a.type()===e[pt].EN_PASSANT_CAPTURE&&zt(n,a.enPassantSquare())[Y]()[ft](mt),a.type()===e[pt].PROMOTION&&tn(n,i,.8,function(){f[b]("rpbui-chessboard-piece-p")[_]("rpbui-chessboard-piece-"+a.promotion())}),t(I,n[u])[tt](R),on(n)}function Zt(e){e[k]=E,t(".rpbui-chessboard-moveArrow",e[u]).remove()}function en(r,i,s,o,u){var a=t(K,zt(r,i));a.parent()[ft](mt),zt(r,s)[Y]()[ft](a);if(u){var f=Xt(r,i,s);tn(r,o,.5,function(){Ut(r,"rpbui-chessboard-moveArrow","B",f.x1,f.y1,f.x2,f.y2)}),r[k]={from:i,to:s}}if(o){var c=e[ut](i),h=e[ut](s),p=(c.r-h.r)*r[n][l]*(r[n][M]?1:-1),v=(h.c-c.c)*r[n][l]*(r[n][M]?1:-1);a.css("top",p+"px"),a.css("left",v+"px"),a.animate({top:"0px",left:"0px"},r[n][d])}return a}function tn(e,t,r,i){t?setTimeout(i,e[n][d]*r):i()}function nn(e,t,n,r){var i=e[s][m](n);typeof i=="object"&&i.color===t.color&&i.piece===t.piece?(e[s][m](n,"-"),r[Y]()[ft](mt)):(e[s][m](n,t),r[Y]()[ft](p+t.piece+X+t.color+'">'+mt+C)),on(e)}function rn(e,t,n,r){e[i][n]===t?(Ft(r,t),delete e[i][n]):(Ft(r,e[i][n],t),e[i][n]=t),un(e)}function sn(e,t,n,i){var s=n+i;e[r][s]===t?(qt(e,s,e[r][s]),delete e[r][s]):(qt(e,s,e[r][s],t),e[r][s]=t),an(e)}function on(e){var t=e[n][L];e[n][L]=e[s].fen(),e[V](it,E,{oldValue:t,newValue:e[n][L]})}function un(e){var t=e[n][g];e[n][g]=St(e[i]),e[V](Z,E,{oldValue:t,newValue:e[n][g]})}function an(e){var t=e[n][w];e[n][w]=St(e[r]),e[V](et,E,{oldValue:t,newValue:e[n][w]})}var n="options",r="_arrowMarkers",i="_squareMarkers",s="_position",o=".rpbui-chessboard-square",u="element",a="rpbui-chessboard-markerColor-",f=".rpbui-chessboard-table",l="squareSize",c="interactionMode",h="rpbui-chessboard-squareMarker",p='<div class="rpbui-chessboard-sized rpbui-chessboard-piece rpbui-chessboard-piece-',d="animationSpeed",v="url(#rpbui-chessboard-arrowMarkerEnd-",m="square",g="squareMarkers",y="undefined",b="removeClass",w="arrowMarkers",E=null,S="_initialGeometryInfo",x=" rpbui-chessboard-markerColor-",T="showMoveArrow",N="showCoordinates",C="</div>",k="_moveArrow",L="position",A="hasOwnProperty",O=!1,M="flip",_="addClass",D=".rpbui-chessboard-draggedArrow",P="12345678",H="87654321",B="hgfedcba",j=".rpbui-chessboard-annotations",F="rpbui-chessboard-arrowMarker-",I=".rpbui-chessboard-turnFlag",q="abcdefgh",R="rpbui-chessboard-inactiveFlag",U="rpbui-chessboard-arrowMarker ",z="rpbui-chessboard-squareHover",W='<div class="',X=" rpbui-chessboard-color-",V="_trigger",$="colorset",J="pieceset",K=".rpbui-chessboard-piece",Q="test",G="rpbui-chessboard-size",Y="empty",Z="squareMarkersChange",et="arrowMarkersChange",tt="toggleClass",nt="rpbui-chessboard",rt="castleRights",it="positionChange",st="play",ot=!0,ut="squareToCoordinates",at="movePieces",ft="append",lt="indexOf",ct="enPassant",ht="draggable",pt="movetype",dt=12,vt=64,mt='<div class="rpbui-chessboard-handle"></div>',gt=/^\s*([GRY])([a-h][1-8])\s*$/,yt=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,bt=/^\s*[GRY]?([a-h][1-8])\s*$/,wt=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;t.chessboard={MINIMUM_SQUARE_SIZE:dt,MAXIMUM_SQUARE_SIZE:vt},t.widget("rpbchess-ui.chessboard",{options:{position:Y,squareMarkers:"",arrowMarkers:"",flip:O,squareSize:32,showCoordinates:ot,animationSpeed:200,showMoveArrow:O,interactionMode:"none",colorset:"",pieceset:""},_position:E,_squareMarkers:E,_arrowMarkers:E,_moveArrow:E,_create:function(){this[u][_](nt).disableSelection(),this[n][L]=Lt(this,this[n][L]),this[n][g]=At(this,this[n][g]),this[n][w]=Ot(this,this[n][w]),this[n][l]=Tt(this[n][l]),this[n][c]=Ct(this[n][c]),this[n][d]=kt(this[n][d]),this[n][M]=xt(this[n][M],O),this[n][N]=xt(this[n][N],ot),this[n][T]=xt(this[n][T],O),this[n][$]=Nt(this[n][$]),this[n][J]=Nt(this[n][J]),Pt(this)},_destroy:function(){this[u][Y]()[b](nt).enableSelection()},_setOption:function(e,t){switch(e){case L:t=Lt(this,t);break;case g:t=At(this,t);break;case w:t=Ot(this,t);break;case l:t=Tt(t);break;case c:t=Ct(t);break;case d:t=kt(t);break;case M:t=xt(t,O);break;case N:t=xt(t,ot);break;case T:t=xt(t,O);break;case $:t=Nt(t);break;case J:t=Nt(t)}var r=this[n][e];if(r===t)return;this[n][e]=t;switch(e){case L:this[k]=E,Pt(this),this[V](it,E,{oldValue:r,newValue:this[n][L]});break;case M:Pt(this),this[V]("flipChange",E,{oldValue:r,newValue:this[n][M]});break;case g:It(this),this[V](Z,E,{oldValue:r,newValue:this[n][g]});break;case w:Rt(this),this[V](et,E,{oldValue:r,newValue:this[n][w]});break;case l:Bt(this,r,t);break;case N:jt(this);break;case d:break;case T:break;default:Pt(this)}},turn:function(e){if(typeof e===y||e===E)return this[s].turn();e!==this[s].turn()&&(this[s].turn(e),Ht(this),on(this))},castleRights:function(e,t,n){if(typeof n===y||n===E)return this[s][rt](e,t);n!==this[s][rt](e,t)&&(this[s][rt](e,t,n),on(this))},enPassant:function(e){if(typeof e===y||e===E)return this[s][ct]();e!==this[s][ct]()&&(this[s][ct](e),on(this))},movePiece:function(e){Gt(this,e,this[n][d]>0,this[n][T])},play:function(e){Yt(this,e,this[n][d]>0,this[n][T])},addSquareMarker:function(e){if(gt[Q](e)){var t=RegExp.$1,n=RegExp.$2;this[i][n]!==t&&(Ft(zt(this,n),this[i][n],t),this[i][n]=t,un(this))}},removeSquareMarker:function(e){if(bt[Q](e)){var t=RegExp.$1;typeof this[i][t]!==y&&(Ft(zt(this,t),this[i][t]),delete this[i][t],un(this))}},addArrowMarker:function(e){if(yt[Q](e)){var t=RegExp.$1,n=RegExp.$2;this[r][n]!==t&&(qt(this,n,this[r][n],t),this[r][n]=t,an(this))}},removeArrowMarker:function(e){if(wt[Q](e)){var t=RegExp.$1;typeof this[r][t]!==y&&(qt(this,t,this[r][t]),delete this[r][t],an(this))}},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[S]===undefined&&(r[S]={squareSize:r[n][l],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[S].width,s=t.size.height-r[S].height,o=Math.floor(i/9),u=Math.floor(s/8),a=r[S][l]+Math.min(o,u);r._setOption(l,a)})}})})(RPBChess,jQuery);