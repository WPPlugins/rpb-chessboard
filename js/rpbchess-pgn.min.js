(function(e){"use strict";function G(e,t,n){this.pgn=e,this.index=t,this[p]=n;for(var r=3;r<arguments[d];++r){var i=new RegExp("%"+(r-2)+"\\$s");this[p]=this[p][v](i,arguments[r])}}function Y(t,n){this[m]=t,this._next=g,this[y]=new e.Position(t[b]());if(n===w){this[E]=w;if(!this[y].playNullMove())throw new e[x][S](this[y],w,Q[r])}else{var i=this[y][T](n);this[E]=this[y][T](i),this[y].play(i)}this[N]=t[b]().turn(),t instanceof Z?this[C]=t[m][C]:this[C]=this[N]==="w"?t[C]+1:t[C],this[k]=t[k],this[L]=[],this[A]=[],this[O]={},this[M]=g,this[_]=D,t instanceof Z?t[P]=this:t._next=this}function Z(e,t){this[m]=e,this[P]=g,this[k]=t,this[A]=[],this[O]={},this[M]=g,this[_]=D,e instanceof et?e[z]=this:e[L][I](this)}function et(){this[X]={},this[V]=new e.Position,this[C]=1,this[$]="*",new Z(this,!0)}function ft(e){var t={},n=e[v](/\[%([a-zA-Z]+) ([^\[\]]+)\]/g,function(e,n,r){return t[n]=r," "});return n=n[v](/^\s+|\s+$/g,"")[v](/\s+/g," "),n===""&&(n=g),{comment:n,tags:t}}function lt(r){function b(){var e=0;while(l<r[d]){var t=r.substr(l);if(/^([ \f\t\v])+/[K](t))l+=RegExp.$1[d];else{if(!/^(\r?\n|\r)/[K](t))break;l+=RegExp.$1[d],++e}}c=e>=2}function w(){b();if(l>=r[d])return D;var e=r.substr(l),n=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/[K](e))n=RegExp.$1[d],h=nt,m={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?|--))/[K](e))n=RegExp.$1[d],h=rt,m=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf|~)|\$([1-9][0-9]*))/[K](e))n=RegExp.$1[d],h=it,m=RegExp.$3[d]===0?tt[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/[K](e))n=RegExp.$1[d],h=st,m=ft(RegExp.$2[v](/\\(\\|\{|\})/g,"$1"));else if(/^(\()/[K](e))n=RegExp.$1[d],h=ot,m=g;else if(/^(\))/[K](e))n=RegExp.$1[d],h=ut,m=g;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/[K](e))throw new G(r,l,Q[t]);n=RegExp.$1[d],h=at,m=RegExp.$1}return y=l,l+=n,!0}var l=0,c=D,h=0,m=g,y=0,E=[],N=g,L=g,P=[];while(w()){N===g&&(N=new et),h!==nt&&L===g&&(L=N[J]());switch(h){case nt:if(L!==g)throw new G(r,y,Q[s]);N[X][m.key]=m.value;if(m.key==="FEN")try{var H=N[V].fen(m.value);N[C]=H[j]}catch(B){throw B instanceof e[x].InvalidFEN?new G(r,y,Q[i],B[p]):B}break;case rt:try{L=new Y(L,m)}catch(B){throw B instanceof e[x][S]?new G(r,y,Q[n],B[T],B[p]):B}break;case it:L[A][I](m);break;case st:L[O]=m.tags,L[M]=m[R],L[_]=L[k]&&c;break;case ot:if(!(L instanceof Y))throw new G(r,y,Q[o]);P[I](L),L=new Z(L,L[k]&&c);break;case ut:if(P[d]===0)throw new G(r,y,Q[u]);L=P.pop();break;case at:if(P[d]>0)throw new G(r,y,Q[a]);N[$]=m,E[I](N),N=g,L=g}}if(N!==g)throw new G(r,r[d],Q[f]);return E}function ct(e,t){var n=lt(e);if(n[d]===0)throw new G(e,-1,Q[l]);if(typeof t=="undefined"||t<0){if(n[d]===1)return n[0];throw new G(e,-1,Q[c])}if(t<n[d])return n[t];throw new G(e,-1,Q[h],t,n[d])}var t="INVALID_PGN_TOKEN",n="INVALID_MOVE_IN_PGN_TEXT",r="INVALID_NULL_MOVE_IN_PGN_TEXT",i="INVALID_FEN_IN_PGN_TEXT",s="UNEXPECTED_PGN_HEADER",o="UNEXPECTED_BEGIN_OF_VARIATION",u="UNEXPECTED_END_OF_VARIATION",a="UNEXPECTED_END_OF_GAME",f="UNEXPECTED_END_OF_TEXT",l="PGN_TEXT_IS_EMPTY",c="PGN_TEXT_CONTAINS_SEVERAL_GAMES",h="INVALID_GAME_INDEX",p="message",d="length",v="replace",m="_parent",g=null,y="_position",b="position",w="--",E="_notation",S="InvalidNotation",x="exceptions",T="notation",N="_movingColor",C="_fullMoveNumber",k="_withinLongVariation",L="_variations",A="_nags",O="_tags",M="_comment",_="_isLongComment",D=!1,P="_first",H="prototype",B="positionBefore",j="fullMoveNumber",F="hasOwnProperty",I="push",q="string",R="comment",U="isLongComment",z="_mainVariation",W="initialPosition",X="_headers",V="_initialPosition",$="_result",J="mainVariation",K="test",Q=e.i18n;Q[t]="Unrecognized character or group of characters.",Q[n]="Invalid move (%1$s). %2$s",Q[r]="Invalid null-move.",Q[i]="Invalid FEN string in the initial position header. %1$s",Q[s]="Unexpected PGN item header.",Q[o]="Unexpected begin of variation.",Q[u]="Unexpected end of variation.",Q[a]="Unexpected end of game: there are pending variations.",Q[f]="Unexpected end of text: there is a pending item.",Q[l]="No game found in the text.",Q[c]="The PGN data contains 2 or more games.",Q[h]="Game index %1$s is invalid (%2$s game(s) found in the PGN data).",Y[H].move=function(){return this[E]},Y[H][B]=function(){return this[m][b]()},Y[H][b]=function(){return this[y]},Y[H][j]=function(){return this[C]},Y[H].moveColor=function(){return this[N]},Y[H].next=function(){return this._next},Y[H].variations=function(){return this[L]},Y[H].nags=function(){return this[A]},Y[H].tags=function(){var e=[];for(var t in this[O])this[O][F](t)&&e[I](t);return e},Y[H].tag=function(e){var t=this[O][e];return typeof t===q?t:g},Y[H][R]=function(){return this[M]},Y[H][U]=function(){return this[_]},Z[H].isLongVariation=function(){return this[k]},Z[H][b]=function(){return this[m]instanceof Y?this[m][B]():this[m][W]()},Z[H].first=function(){return this[P]},Z[H].nags=Y[H].nags,Z[H].tags=Y[H].tags,Z[H].tag=Y[H].tag,Z[H][R]=Y[H][R],Z[H][U]=Y[H][U],et[H].headers=function(){var e=[];for(var t in this[X])this[X][F](t)&&e[I](t);return e},et[H].header=function(e){var t=this[X][e];return typeof t===q?t:g},et[H][W]=function(){return this[V]},et[H][J]=function(){return this[z]},et[H].result=function(){return this[$]};var tt={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+/=":14,"+=":14,"=":10,"~":13,inf:13,"=/+":15,"=+":15,"-/+":17,"-+":19},nt=1,rt=2,it=3,st=4,ot=5,ut=6,at=7;e[x].InvalidPGN=G,e.pgn={Node:Y,Variation:Z,Item:et,parse:lt,parseOne:ct}})(RPBChess);